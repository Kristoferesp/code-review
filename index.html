<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Financeiro Ultra</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --dark-bg: #1f2937;
            --light-bg: #f3f4f6;
            --text-main: #1f2937;
            --card-bg: #ffffff;
        }

        /* Dark Mode Class */
        body.dark-mode {
            --light-bg: #111827;
            --text-main: #f3f4f6;
            --card-bg: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; }

        body { 
            background-color: var(--light-bg); color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh;
        }

        .container { background: var(--card-bg); width: 100%; max-width: 900px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }

        .top-controls { width: 100%; max-width: 900px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .config-btns { display: flex; gap: 10px; }


        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .card { text-align: center; padding: 20px; border-radius: 8px; border: 1px solid #eee; background: var(--card-bg); }
        .money-plus { color: var(--success); font-weight: bold; font-size: 1.2rem; }
        .money-minus { color: var(--danger); font-weight: bold; font-size: 1.2rem; }

        /* Grid Principal */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* Gr√°fico */
        .chart-container { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; height: 300px; display: flex; justify-content: center;}

        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .list { list-style: none; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px; border-radius: 5px; }
        .list li { font-size: 13px; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .cat-tag { font-size: 10px; background: #eee; color: #666; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }

        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; background: var(--card-bg); color: var(--text-main); }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); font-size: 12px; }
        .btn-danger { background: var(--danger); font-size: 12px; }
        .btn-success { background: var(--success); font-size: 12px; }

        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="top-controls">
        <div class="config-btns">
            <button class="btn btn-outline" onclick="toggleDarkMode()">üåô Modo Escuro</button>
            üé® <input type="color" id="bg-picker" style="width: 40px; height: 30px; padding: 0; margin: 0;">
        </div>
        <div class="config-btns">
            <button class="btn btn-success" onclick="exportData()">üíæ Exportar</button>
            <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">üìÇ Importar</button>
            <input type="file" id="import-file" style="display: none" onchange="importData(event)">
            <button class="btn btn-danger" onclick="resetAll()">üóëÔ∏è Reset</button>
        </div>
    </div>

    <div class="container">
        <h2>üöÄ Simulador Financeiro Ultra</h2>

        <div class="dashboard">
            <div class="card"><h4>Entradas</h4><p id="inc" class="money-plus">R$ 0</p></div>
            <div class="card"><h4>Sa√≠das</h4><p id="exp" class="money-minus">R$ 0</p></div>
            <div class="card"><h4>Saldo Atual</h4><p id="bal" style="font-size: 1.2rem;">R$ 0</p></div>
        </div>

        <!-- GR√ÅFICO NOVO -->
        <div class="chart-container">
            <canvas id="expenseChart"></canvas>
        </div>

        <div class="main-grid">
            <!-- Transa√ß√µes -->
            <div>
                <div class="list-header">
                    <h3>Transa√ß√µes</h3>
                    <select id="filter-type" style="width: auto; margin: 0; padding: 2px;" onchange="update()">
                        <option value="all">Todas</option>
                        <option value="receita">Receitas</option>
                        <option value="despesa">Despesas</option>
                    </select>
                </div>
                <ul id="trans-list" class="list"></ul>
                <form id="trans-form" style="margin-top: 15px;">
                    <input type="text" id="t-text" placeholder="Ex: Sal√°rio, Aluguel" required>
                    <input type="number" id="t-amount" placeholder="Valor (R$)" step="0.01" required>
                    <div style="display: flex; gap: 5px;">
                        <select id="t-type">
                            <option value="receita">Receita (+)</option>
                            <option value="despesa">Despesa (-)</option>
                        </select>
                        <select id="t-cat">
                            <option value="Geral">Geral</option>
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Moradia">Moradia</option>
                            <option value="Lazer">Lazer</option>
                            <option value="Sa√∫de">Sa√∫de</option>
                            <option value="Transporte">Transporte</option>
                        </select>
                    </div>
                    <button class="btn btn-primary">‚ûï Adicionar Lan√ßamento</button>
                </form>
            </div>

            <!-- Metas -->
            <div>
                <h3>Metas de Economia</h3>
                <div id="goals-container"></div>
                <form id="goal-form" style="border-top: 1px solid #eee; padding-top: 10px;">
                    <input type="text" id="g-name" placeholder="Nome da Meta" required>
                    <input type="number" id="g-target" placeholder="Quanto precisa poupar?" required>
                    <button class="btn btn-primary" style="background: var(--dark-bg);">üéØ Criar Meta</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis de Estado
        let transactions = JSON.parse(localStorage.getItem('trans_v3')) || [];
        let goals = JSON.parse(localStorage.getItem('goals_v3')) || [];
        let myChart = null;

        // 1. Fun√ß√£o Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

        // 2. Exportar Dados (JSON)
        function exportData() {
            const data = JSON.stringify({ transactions, goals });
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meu_backup_financeiro.json';
            a.click();
        }

        // 3. Importar Dados
        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const imported = JSON.parse(e.target.result);
                transactions = imported.transactions;
                goals = imported.goals;
                update();
            };
            reader.readAsText(file);
        }

        // 4. Reset Total
        function resetAll() {
            if(confirm("Deseja apagar todos os dados?")) {
                transactions = []; goals = []; update();
            }
        }

        // 5. Gr√°fico de Pizza
        function updateChart(dataMap) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);

            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#3b82f6', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#34495e']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // L√≥gica de Atualiza√ß√£o
        function update() {
            localStorage.setItem('trans_v3', JSON.stringify(transactions));
            localStorage.setItem('goals_v3', JSON.stringify(goals));

            const filter = document.getElementById('filter-type').value;
            const filtered = transactions.filter(t => filter === 'all' || t.type === filter);

            // C√°lculos
            const income = transactions.filter(t => t.amount > 0).reduce((acc, t) => acc + t.amount, 0);
            const expense = Math.abs(transactions.filter(t => t.amount < 0).reduce((acc, t) => acc + t.amount, 0));
            const total = income - expense;

            document.getElementById('inc').innerText = income.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('exp').innerText = expense.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('bal').innerText = total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('bal').className = total >= 0 ? 'money-plus' : 'money-minus';

            // Lista de Transa√ß√µes
            const listEl = document.getElementById('trans-list');
            listEl.innerHTML = '';
            const categoryExpenses = {};

            filtered.forEach(t => {
                if(t.amount < 0) {
                    categoryExpenses[t.cat] = (categoryExpenses[t.cat] || 0) + Math.abs(t.amount);
                }
                const li = document.createElement('li');
                li.innerHTML = `
                    <div><b>${t.text}</b> <span class="cat-tag">${t.cat}</span></div>
                    <span class="${t.amount < 0 ? 'money-minus' : 'money-plus'}">
                        ${t.amount.toLocaleString('pt-BR')} 
                        <button class="delete-btn" onclick="removeTrans(${t.id})"> x </button>
                    </span>
                `;
                listEl.appendChild(li);
            });

            updateChart(categoryExpenses);

            const goalsEl = document.getElementById('goals-container');
            goalsEl.innerHTML = '';
            goals.forEach(g => {
                const percent = Math.min((total / g.target) * 100, 100).toFixed(0);
                const displayPercent = total > 0 ? percent : 0;
                goalsEl.innerHTML += `
                    <div style="margin-bottom: 15px">
                        <div style="display:flex; justify-content:space-between; font-size:12px">
                            <strong>${g.name}</strong>
                            <span>${displayPercent}% <button class="delete-btn" onclick="removeGoal(${g.id})">üóëÔ∏è</button></span>
                        </div>
                        <div style="background:#eee; height:8px; border-radius:5px; margin-top:5px">
                            <div style="background:var(--primary); height:100%; width:${displayPercent}%; border-radius:5px"></div>
                        </div>
                    </div>`;
            });
        }

        // Gatilhos de Formul√°rio
        document.getElementById('trans-form').onsubmit = (e) => {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('t-amount').value);
            transactions.push({
                id: Date.now(),
                text: document.getElementById('t-text').value,
                cat: document.getElementById('t-cat').value,
                type: document.getElementById('t-type').value,
                amount: document.getElementById('t-type').value === 'despesa' ? -Math.abs(amt) : Math.abs(amt)
            });
            update(); e.target.reset();
        };

        document.getElementById('goal-form').onsubmit = (e) => {
            e.preventDefault();
            goals.push({ id: Date.now(), name: document.getElementById('g-name').value, target: parseFloat(document.getElementById('g-target').value) });
            update(); e.target.reset();
        };

        function removeTrans(id) { transactions = transactions.filter(t => t.id !== id); update(); }
        function removeGoal(id) { goals = goals.filter(g => g.id !== id); update(); }

        // Cor de Fundo
        const bgPicker = document.getElementById('bg-picker');
        bgPicker.value = localStorage.getItem('bgColor') || '#f3f4f6';
        document.body.style.backgroundColor = bgPicker.value;
        bgPicker.oninput = (e) => {
            document.body.style.backgroundColor = e.target.value;
            localStorage.setItem('bgColor', e.target.value);
        };

        update();
    </script>
</body>
</html>